{% extends "base.html" %}

{% block content %}
<div class="container mx-auto px-4 py-8">
    <div class="flex justify-between items-center mb-6">
        <h1 class="text-3xl font-bold text-gray-800 dark:text-gray-100">{{ _('admin.translations_title', 'Manage
            Translations') }}</h1>
        <a href="/dashboard"
            class="text-indigo-600 dark:text-indigo-400 hover:text-indigo-800 dark:hover:text-indigo-300">Back to
            Dashboard</a>
    </div>

    <!-- Admin Navigation -->
    <div class="flex space-x-2 mb-8 border-b border-gray-200 dark:border-gray-700">
        <a href="{{ url_for('admin_benchmarks') }}"
            class="py-2 px-4 border-b-2 border-transparent text-gray-500 hover:text-indigo-600 font-medium transition dark:text-gray-400 dark:hover:text-indigo-300">
            {{ _('admin.benchmarks', 'Benchmarks') }}
        </a>
        <a href="{{ url_for('manage_users') }}"
            class="py-2 px-4 border-b-2 border-transparent text-gray-500 hover:text-indigo-600 font-medium transition dark:text-gray-400 dark:hover:text-indigo-300">
            {{ _('admin.users_nav', 'Users') }}
        </a>
        <a href="{{ url_for('admin_translations') }}"
            class="py-2 px-4 border-b-2 border-indigo-500 text-indigo-600 font-bold dark:text-indigo-400">
            {{ _('admin.translations_nav', 'Translations') }}
        </a>
    </div>

    <div class="flex justify-end mb-4">
        <form action="{{ url_for('init_keys') }}" method="POST">
            <button type="submit"
                class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded transition">
                {{ _('admin.init_keys', 'Initialize Keys') }}
            </button>
        </form>
    </div>

    <div class="mb-4">
        <form action="{{ url_for('add_translation_key') }}" method="POST" class="flex gap-2">
            <input type="text" name="key" placeholder="new.key.name" required
                class="shadow appearance-none border rounded py-2 px-3 text-gray-700 dark:bg-gray-700 dark:text-white leading-tight focus:outline-none focus:shadow-outline">
            <input type="text" name="description" placeholder="Description"
                class="shadow appearance-none border rounded py-2 px-3 text-gray-700 dark:bg-gray-700 dark:text-white leading-tight focus:outline-none focus:shadow-outline flex-grow">
            <button type="submit"
                class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded transition">{{
                _('common.add', 'Add') }}</button>
        </form>
    </div>

    <!-- Translations Matrix -->
    <div class="bg-white dark:bg-gray-800 rounded-lg shadow overflow-x-auto">
        <table class="min-w-full divide-y divide-gray-200 dark:divide-gray-700">
            <thead class="bg-gray-50 dark:bg-gray-700">
                <tr>
                    <th
                        class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider sticky left-0 bg-gray-50 dark:bg-gray-700 z-10">
                        {{ _('admin.key', 'Key') }}</th>
                    <th
                        class="px-6 py-3 text-center text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider sticky left-1 bg-gray-50 dark:bg-gray-700 z-10">
                        {{ _('admin.description', 'Description') }}</th>
                    {% for lang in languages %}
                    <th
                        class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">
                        {{ lang.name }} ({{ lang.code }})</th>
                    {% endfor %}
                </tr>
            </thead>
            <tbody class="bg-white dark:bg-gray-800 divide-y divide-gray-200 dark:divide-gray-700">
                {% for item in translation_data %}
                <tr>
                    <td
                        class="px-6 py-4 whitespace-nowrap font-mono text-sm text-gray-900 dark:text-gray-200 sticky left-0 bg-white dark:bg-gray-800 z-10">
                        {{ item.key.key }}</td>
                    <td
                        class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 dark:text-gray-400 sticky left-1 bg-white dark:bg-gray-800 z-10">
                        {{ item.key.description }}</td>
                    {% for lang in languages %}
                    <td class="px-6 py-4 whitespace-nowrap">
                        <textarea onchange="updateTranslation(this, '{{ lang.id }}', '{{ item.key.id }}')"
                            class="w-full bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded px-2 py-1 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 text-gray-900 dark:text-gray-100"
                            rows="1">{{ item.translations.get(lang.id, '') }}</textarea>
                    </td>
                    {% endfor %}
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<script>
    async function updateTranslation(element, langId, keyId) {
        const value = element.value;

        // Visual feedback
        element.classList.add('border-yellow-400');

        try {
            const response = await fetch('/api/translations/update', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    language_id: langId,
                    key_id: keyId,
                    value: value
                })
            });

            const data = await response.json();

            if (data.success) {
                element.classList.remove('border-yellow-400');
                element.classList.add('border-green-500');
                setTimeout(() => element.classList.remove('border-green-500'), 2000);
            } else {
                alert('Failed to save: ' + data.message);
                element.classList.add('border-red-500');
            }
        } catch (error) {
            console.error('Error:', error);
            alert('Error saving translation');
            element.classList.add('border-red-500');
        }
    }
</script>
{% endblock %}